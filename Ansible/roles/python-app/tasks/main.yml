---
- name: Create application directory
  file:
    path: "{{ app_directory }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'

- name: Deploy Python application files
  copy:
    src: "python_server/"
    dest: "{{ app_directory }}"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'

- name: Create systemd service
  template:
    src: python-server.service.j2
    dest: /etc/systemd/system/python-server.service
    owner: "{{ root_user }}"
    group: "{{ root_user }}"
    mode: "{{ config_mode }}"
  notify: restart python server

- name: Ensure Python service is enabled and started
  systemd:
    name: python-server
    state: started
    enabled: yes

- name: Wait for application to start
  wait_for:
    port: "{{ app_port }}"
    host: localhost
    delay: 5
    timeout: 30

- name: Verify application health
  uri:
    url: "http://localhost:{{ app_port }}"
    method: GET
    status_code: 200
    timeout: 10
  register: health_check
  retries: 3
  delay: 2

- name: Show application status
  debug:
    msg: "Application started successfully on port {{ app_port }}"
# tasks file for pythin-app
